WITH transacted_customers AS (
    SELECT 
        month,
        month_number,
        COUNT(DISTINCT phone_number) AS transacted_count
    FROM
        bambaswap_combined_jan_sep_2024
    WHERE
        state = 'complete'
    GROUP BY
        month, month_number
),
total_leads AS (
    SELECT 
        month,
        month_number,
        COUNT(DISTINCT phone_number) AS total_leads_count
    FROM
        bambaswap_combined_jan_sep_2024
    GROUP BY
        month, month_number
)
SELECT 
    t.month,
    t.month_number,
    t.transacted_count,
    l.total_leads_count,
    ROUND(
        (t.transacted_count::decimal / l.total_leads_count) * 100, 2
    ) AS conversion_rate_percentage
FROM
    transacted_customers t
JOIN
    total_leads l ON t.month = l.month AND t.month_number = l.month_number
ORDER BY
    t.month_number;
