WITH arpu AS (
    -- Calculate total revenue for each month
    SELECT
        month,
        month_number,
        SUM(bs_revenue) AS total_revenue
    FROM
        bambaswap_combined_jan_sep_2024
    GROUP BY
        month, month_number
), 
filtered_numbers AS (
    -- Count the number of loyal customers (phone numbers that appear 3 or more times in a month)
    SELECT 
        month,
        month_number,
        COUNT(DISTINCT phone_number) AS loyal_customers
    FROM (
        SELECT 
            phone_number,
            month,
            month_number
        FROM bambaswap_combined_jan_sep_2024
        GROUP BY 
            phone_number, month, month_number
        HAVING COUNT(*) > 1 -- Loyal customers appear 3 or more times in the month
    ) AS loyal_customers_per_month
    GROUP BY 
        month, month_number
)
-- Calculate ARPU (Total Revenue / Number of Loyal Customers) per month
, arpu_calculation AS (
    SELECT 
        arpu.month,
        arpu.month_number,
        -- Use COALESCE to handle NULL values for loyal_customers
        ROUND(CASE 
            WHEN COALESCE(filtered_numbers.loyal_customers, 0) = 0 THEN 0 
            ELSE arpu.total_revenue / COALESCE(filtered_numbers.loyal_customers, 0)
        END, 2) AS arpu
    FROM
        arpu
    LEFT JOIN 
        filtered_numbers ON arpu.month = filtered_numbers.month
)
-- Final MRR calculation for each month
SELECT 
    arpu_calculation.month,                -- Month in date format (e.g., 2023-01-01)
    arpu_calculation.month_number,         -- Month number (e.g., 1 for January)
    arpu_calculation.arpu,                 -- ARPU value
    -- Calculate MRR as ARPU * loyal customers, using COALESCE to handle missing values
    ROUND(CASE 
        WHEN COALESCE(filtered_numbers.loyal_customers, 0) = 0 THEN 0 
        ELSE arpu_calculation.arpu * COALESCE(filtered_numbers.loyal_customers, 0)
    END, 2) AS mrr -- MRR calculation
FROM
    arpu_calculation
LEFT JOIN 
    filtered_numbers ON arpu_calculation.month = filtered_numbers.month
ORDER BY 
    arpu_calculation.month_number;
