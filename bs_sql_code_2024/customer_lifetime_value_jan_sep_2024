CREATE TABLE customer_lifetime_value_jan_sep_2024 AS
WITH customers_current_month AS (
    -- Get distinct customers who made at least one transaction in each month
    SELECT 
        phone_number,
        month_number,
        month
    FROM 
        bambaswap_combined_jan_sep_2024
    GROUP BY 
        phone_number, month_number, month
),
customers_next_month AS (
    -- Get distinct customers who made at least one transaction in the next month
    SELECT 
        phone_number,
        month_number AS next_month_number
    FROM 
        bambaswap_combined_jan_sep_2024
    GROUP BY 
        phone_number, month_number
),
monthly_revenue AS (
    -- Calculate total revenue and ARPU for each month
    SELECT 
        month_number,
        month,
        SUM(bs_revenue) AS total_revenue,
        COUNT(DISTINCT phone_number) AS total_customers,
        ROUND (SUM(bs_revenue) / COUNT(DISTINCT phone_number),2) AS arpu -- ARPU calculation
    FROM 
        bambaswap_combined_jan_sep_2024
    GROUP BY 
        month_number, month
),
churn_rate AS (
    -- Calculate churn rate for each month
    SELECT 
        cm.month,                              -- 3-letter month name
        cm.month_number,                                -- Numeric month
        COUNT(DISTINCT cm.phone_number) AS total_customers, -- Total customers in the month
        ROUND (COUNT(DISTINCT cm.phone_number) - COUNT(DISTINCT nm.phone_number),2) AS churned_customers, -- Customers who churned
        ROUND((COUNT(DISTINCT cm.phone_number) - COUNT(DISTINCT nm.phone_number)) * 100.0 / COUNT(DISTINCT cm.phone_number), 2) AS churn_rate -- Churn rate calculation
    FROM 
        customers_current_month cm
    LEFT JOIN 
        customers_next_month nm 
    ON 
        cm.phone_number = nm.phone_number 
        AND cm.month_number = nm.next_month_number - 1 -- Join with next month data
    GROUP BY 
        cm.month, cm.month_number
)
-- Final CLV calculation: CLV = ARPU / Churn Rate
SELECT 
    mr.month, -- 3-letter month name
    mr.month_number,   -- Numeric month
    mr.arpu,           -- Average Revenue Per User (ARPU)
    cr.churn_rate,     -- Churn Rate (%)
    CASE 
        WHEN cr.churn_rate > 0 THEN ROUND(mr.arpu / (cr.churn_rate / 100), 2)  -- CLV calculation
        ELSE NULL
    END AS clv         -- CLV calculation (if churn_rate > 0)
FROM 
    monthly_revenue mr
JOIN 
    churn_rate cr ON mr.month_number = cr.month_number
ORDER BY 
    mr.month_number;

SELECT *
FROM customer_lifetime_value_jan_sep_2024;